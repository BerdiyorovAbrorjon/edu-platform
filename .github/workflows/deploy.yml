name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1
        env:
          ENV_FILE: ${{ secrets.ENV_FILE }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: root
          password: ${{ secrets.SERVER_PASSWORD }}
          envs: ENV_FILE
          script: |
            set -e

            cd /root/edu-platform

            # 1) repo update
            git fetch --all
            git reset --hard origin/main

            # 2) write .env from secret
            echo "$ENV_FILE" > .env
            chmod 600 .env
            # 3) pull/build + restart (NO -v, run in background)
            docker compose pull || true
            docker compose up -d --build --force-recreate
            # 4) cleanup old images (optional)
            docker image prune -f
